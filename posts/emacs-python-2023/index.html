<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-gb lang=en-gb><head><script src=https://georgek.github.io/blog/js/early.min.8bbbb9e374f9a31ff012ccd8e17b750da15211875e9e896d6ea765d7e3c2179a.js integrity="sha256-i7u543T5ox/wEszY4Xt1DaFSEYdenoltbqdl1+PCF5o="></script>
<script defer language=javascript type=text/javascript src=/blog/js/bundle.min.9bc659498fc45b111b2ed113be115802c52a7655c77845205d1328982715ac7d.js></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/blog/favicon.ico><meta name=color-scheme content="light dark"><title itemprop=name>gpk blog - My 2023 Emacs Python Setup</title><meta property="og:title" content="gpk blog - My 2023 Emacs Python Setup"><meta name=twitter:title content="gpk blog - My 2023 Emacs Python Setup"><meta itemprop=name content="gpk blog - My 2023 Emacs Python Setup"><meta name=application-name content="gpk blog - My 2023 Emacs Python Setup"><meta property="og:site_name" content><meta name=description content="My new configuration with Emacs 29, Eglot, python-lsp-server and tree-sitter"><meta itemprop=description content="My new configuration with Emacs 29, Eglot, python-lsp-server and tree-sitter"><meta property="og:description" content="My new configuration with Emacs 29, Eglot, python-lsp-server and tree-sitter"><meta name=twitter:description content="My new configuration with Emacs 29, Eglot, python-lsp-server and tree-sitter"><base href=https://georgek.github.io/blog/posts/emacs-python-2023/><link rel=canonical href=https://georgek.github.io/blog/posts/emacs-python-2023/ itemprop=url><meta name=url content="https://georgek.github.io/blog/posts/emacs-python-2023/"><meta name=twitter:url content="https://georgek.github.io/blog/posts/emacs-python-2023/"><meta property="og:url" content="https://georgek.github.io/blog/posts/emacs-python-2023/"><meta property="og:updated_time" content="15008-15-02T819:00:23Z"><link rel=sitemap type=application/xml title=Sitemap href=https://georgek.github.io/blog/sitemap.xml><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"><meta name=twitter:site content><meta name=twitter:creator content><meta property="fb:admins" content><meta name=apple-mobile-web-app-title content><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta property="og:type" content="article"><meta property="article:publisher" content><meta property="og:article:published_time" content="15008-15-02T819:00:23Z"><meta property="article:published_time" content="15008-15-02T819:00:23Z"><meta property="og:article:author" content="George Kettleborough"><meta property="article:author" content="George Kettleborough"><meta name=author content="George Kettleborough"><meta name=generator content="Hugo 0.119.0"><script></script><link type=text/css rel=stylesheet href=/blog/css/bundle.min.0ee766e1688f22429b7953191d8b9751044be49541213446b960d70f33fe30cc.css><style>:root{--sidebar-bg-color:#202420;--sidebar-img-border-color:#515751;--sidebar-p-color:#909090;--sidebar-h1-color:#FFF;--sidebar-a-color:#FFF;--sidebar-socials-color:#FFF;--text-color:#222;--bkg-color:#FAF9F6;--post-title-color:#303030;--list-color:#3a3a3a;--link-color:#268bd2;--date-color:#515151;--table-border-color:#E5E5E5;--table-stripe-color:#F9F9F9;--code-color:#bf616a;--code-background-color:#E5E5E5;--code-block-color:#fff;--code-block-background-color:#272822;--moon-sun-color:#FFF;--moon-sun-background-color:#515751}@media screen{[data-theme=dark]{--text-color:#eee;--bkg-color:#121212;--post-title-color:#DBE2E9;--list-color:#bdbdbd;--link-color:#268bd2;--date-color:#9a9a9a;--table-border-color:#515151;--table-stripe-color:#202020;--code-color:#ff7f7f;--code-background-color:#393D47;--code-block-color:#fff;--code-block-background-color:#272822}}body{background-color:var(--bkg-color)}</style><meta name=google-site-verification content="0kCOfXcz_aAJKh_eZglpQdpUUfE2IqecYZesW3oUOJo"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Lora:ital@0;1&family=Vollkorn:ital,wght@0,800;1,800&display=swap" rel=stylesheet><link rel=stylesheet href=https://georgek.github.io/blog/css/maplibre-gl.731181d400d65a8b09d842f55b70bc4dc11010b15b8549e2c65a69d233fbdd2e.css><script defer src=https://georgek.github.io/blog/js/mapbundle.min.8bd4d2a91deafa4229a45caddeb4672638b283c84dc61d0aec9d79d39a6ee67c.js integrity="sha256-i9TSqR3q+kIppFyt3rRnJjiyg8hNxh0K7J1505pu5nw="></script></head><body><div class=wrapper><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://georgek.github.io/blog/ class=brand-image><img src=/blog/android-chrome-192x192.png alt="brand image"></a><h1 class=brand><a href=https://georgek.github.io/blog/><h1>gpk blog</h1></a></h1><p class=lead>My ramblings about emacs, the internet and everything</p><div class=light-dark align=right><button class=btn-light-dark title="Toggle light/dark mode"><svg display="none" class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg display="none" class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button></div></div><nav><ul class=sidebar-nav><li class=heading><a href=/blog/about/>About</a></li><li class=heading><a href=/blog/categories/>Categories</a></li><li class=heading><a href=/blog/tags/>Tags</a></li></ul></nav><div class=socials><a target=_blank class=social title=GitHub href=https://github.com/georgek><svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24"><path fill="currentcolor" d="M18.88 1.099C18.147.366 17.265.0 16.233.0H3.746C2.714.0 1.832.366 1.099 1.099.366 1.832.0 2.714.0 3.746v12.487c0 1.032.366 1.914 1.099 2.647.733.733 1.615 1.099 2.647 1.099H6.66c.19.0.333-.007.429-.02a.504.504.0 00.286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555.0 01-.904-.091 2.026 2.026.0 01-.872-.39 1.651 1.651.0 01-.572-.8l-.13-.3a3.25 3.25.0 00-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956.0 01-.17-.156.723.723.0 01-.117-.182c-.026-.061-.004-.111.065-.15.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1.0 01.631.677c.2.355.44.626.722.813.282.186.566.28.852.28.286.0.533-.022.742-.065a2.59 2.59.0 00.585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907.0 01-1.333-.234 5.314 5.314.0 01-1.223-.507 3.5 3.5.0 01-1.047-.872c-.277-.347-.505-.802-.683-1.365-.177-.564-.266-1.215-.266-1.952.0-1.049.342-1.942 1.027-2.68-.32-.788-.29-1.673.091-2.652.252-.079.625-.02 1.119.175.494.195.856.362 1.086.5.23.14.414.257.553.352a9.233 9.233.0 012.497-.338c.859.0 1.691.113 2.498.338l.494-.312a6.997 6.997.0 011.197-.572c.46-.174.81-.221 1.054-.143.39.98.424 1.864.103 2.653.685.737 1.028 1.63 1.028 2.68.0.737-.089 1.39-.267 1.957-.177.568-.407 1.023-.689 1.366a3.65 3.65.0 01-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9.0 01-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36.0 00.208.189c.096.034.18.056.254.064.074.01.18.013.318.013h2.914c1.032.0 1.914-.366 2.647-1.099.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/></svg></a><a target=_blank class=social title=Gitlab href=https://gitlab.com/gkettleborough><svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2.5 24 24"><path fill="currentcolor" d="M10.006 18.443 6.326 7.118h7.36l-3.68 11.325zm0 0L1.168 7.118h5.158l3.68 11.325zM1.168 7.118l8.838 11.325-9.68-7.032a.762.762.0 01-.276-.852l1.118-3.441zm0 0L3.385.296a.38.38.0 01.724.0l2.217 6.822H1.168zm8.838 11.325 3.68-11.325h5.157l-8.837 11.325zm8.837-11.325 1.119 3.441a.762.762.0 01-.277.852l-9.68 7.032 8.838-11.325zm0 0h-5.157L15.902.296a.38.38.0 01.725.0l2.216 6.822z"/></svg></a><a target=_blank class=social title="RSS Feed" href=https://georgek.github.io/blog//posts/index.xml><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 1280 1280"><g transform="translate(0.000000,1280.000000) scale(0.100000,-0.100000)" fill="currentcolor"><path d="M2295 11929c-284-12-642-45-707-65-17-5-18-63-18-1039 0-569 4-1036 8-1039 5-3 74 6 153 19 510 86 1168 95 1789 25 1348-153 2602-677 3670-1531 385-308 820-744 1126-1129 842-1060 1362-2313 1514-3650 70-621 61-1279-25-1789-13-79-22-148-19-153 3-4 471-8 1039-8h1035l5 23c51 225 85 942 67 1419-23 605-77 1044-198 1617-294 14e2-927 2734-1823 3846-1043 1295-2364 2259-3909 2854-1158 447-2451 656-3707 6e2z"/><path d="M2255 7845c-269-25-620-81-667-106-17-9-18-55-18-899 0-706 3-890 13-890 6 0 66 18 132 41 130 44 288 79 467 105 154 21 577 30 749 15 1207-107 2267-823 2814-1902 166-327 268-637 330-1001 38-227 48-384 42-662-8-348-44-590-126-831-23-66-41-126-41-132 0-10 184-13 890-13 844 0 890 1 899 18 27 50 88 452 110 725 14 162 14 624 1 782-59 703-233 1323-545 1945-481 956-1313 1788-2270 2268-620 310-1239 483-1940 542-165 14-669 10-840-5z"/><path d="M2519 3815c-391-66-725-336-868-703-79-201-96-462-45-677 83-344 338-641 666-774 116-47 205-69 330-80 412-39 811 153 1040 5e2 193 292 240 648 128 981-135 403-492 699-914 757-1e2 14-241 12-337-4z"/></g></svg></a><a target=_blank class=social title=Email href=mailto://kettlegatgmail.com><svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1.2em" viewBox="0 0 485.211 485.211"><path fill="currentcolor" d="M301.393 241.631 464.866 424.56H20.332l163.474-182.928 58.801 51.443 58.786-51.444zM462.174 60.651H23.027l219.579 192.142L462.174 60.651zM324.225 221.67l160.986 180.151V80.792L324.225 221.67zM0 80.792v321.029L160.972 221.64.0 80.792z"/></svg></a></div><p class=footnote>Powered by <a target=_blank href=https://gohugo.io>Hugo</a> | Themed with <a target=_blank href=https://github.com/georgek/poison>Poison</a></p><p class=footnote>© George Kettleborough
<a href="http://creativecommons.org/licenses/by-sa/4.0/?ref=chooser-v1" target=_blank rel="license noopener noreferrer">CC BY-SA 4.0</a></p></div></aside><main class="content container"><div class=post><div class=info><h1 class=post-title><a href=https://georgek.github.io/blog/posts/emacs-python-2023/>My 2023 Emacs Python Setup</a></h1>George Kettleborough
·
<time datetime=2023-08-15T14:19:00Z class=post-date>August 15, 2023</time><ul class=tags><li class=tag-emacs><a href=https://georgek.github.io/blog/tags/emacs>emacs</a></li><li class=tag-python><a href=https://georgek.github.io/blog/tags/python>python</a></li></ul></div><p>I&rsquo;ve been using Emacs for almost 15 years now. Somewhat surprisingly, I hadn&rsquo;t touched
my config in three years! It&rsquo;s been working that well. But now that Emacs 29 has been
released I&rsquo;ve decided to take a look at what&rsquo;s new and there have been some big changes,
particularly for Python.</p><h2 id=goodbye-elpy-goodbye-projectile>Goodbye Elpy, Goodbye Projectile</h2><p><a href=https://github.com/jorgenschaefer/elpy/ target=_blank>Elpy</a> has been the primary mode for Python development for me for years now. But sadly,
it looks like the project is no more. The good news is there are better ways to do what
it did. It&rsquo;s bittersweet to say goodbye to it and I will be eternally grateful to the
authors, but progress is progress.</p><p>Similarly, <a href=https://github.com/bbatsov/projectile target=_blank>Projectile</a> was what I used to manage projects. But now Emacs has project.el
built in and I&rsquo;ve opted to use that instead. One nice thing about project.el is it uses
other standard stuff underneath like xref. I configured xref to use <a href=https://github.com/BurntSushi/ripgrep target=_blank>Ripgrep</a> and now the
Project commands like <code>C-x p g</code> use Ripgrep:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>(<span style=color:#b58900>use-package</span> <span style=color:#268bd2>xref</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2</span><span>  <span style=color:#b58900>:config</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3</span><span>  (<span style=color:#b58900>setq</span> <span style=color:#268bd2>xref-search-program</span> <span style=color:#2aa198>&#39;ripgrep</span>))
</span></span></code></pre></div><h2 id=native-builds-and-tree-sitter>Native builds and tree-sitter</h2><p>I always build Emacs myself from source if I can. I run Gentoo on my personal computer
so that goes without saying, but I do it on Ubuntu too, if only to get the latest
versions. This does mean I can easily enable a couple of new features: native builds
and tree-sitter.</p><p>On Gentoo this was a simple as adding a couple of USE flags to portage. My USE flags
for emacs now look like:</p><pre tabindex=0><code class=language-nil data-lang=nil>app-editors/emacs athena cairo gui gtk harfbuzz json libxml2 source tree-sitter jit -X
</code></pre><p>The <code>gtk -X</code> also implies a <code>pgtk</code> build which is nice because I use wayland (sway).</p><p>On Ubuntu (20.04, yeah, old, this is one reason I prefer rolling distros) it was more
difficult. I first pulled the source code (<code>emacs-29.1.tar.gz</code>) from a <a href=http://ftpmirror.gnu.org/emacs/ target=_blank>nearby GNU
mirror</a> per the <a href=https://www.gnu.org/software/emacs/download.html target=_blank>GNU website</a>. Then a few packages are required (I use i3/X11 on
Ubuntu):</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>sudo apt install autoconf make gcc texinfo libgtk-3-dev libxpm-dev libjpeg-dev <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2</span><span><span style=color:#cb4b16></span>     libgif-dev libtiff5-dev libgnutls28-dev libncurses5-dev libjansson-dev <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3</span><span><span style=color:#cb4b16></span>     libharfbuzz-dev libharfbuzz-bin imagemagick libmagickwand-dev libgccjit-10-dev <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4</span><span><span style=color:#cb4b16></span>     libgccjit0 gcc-10 libjansson4 libjansson-dev xaw3dg-dev texinfo libx11-dev
</span></span></code></pre></div><p>Now, because <code>libgccjit</code> (required for native builds) is only for GCC 10, the build
process has to be configured for GCC 10 specifically, in addition to enabling all the
wanted features:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span><span style=color:#268bd2>CC</span><span style=color:#719e07>=</span><span style=color:#2aa198>&#34;gcc-10&#34;</span> ./configure --prefix<span style=color:#719e07>=</span><span style=color:#268bd2>$HOME</span> --with-json --with-native-compilation<span style=color:#719e07>=</span>aot <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2</span><span><span style=color:#cb4b16></span>  --with-modules --with-compress-install --with-threads --with-included-regex <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3</span><span><span style=color:#cb4b16></span>  --with-x-toolkit<span style=color:#719e07>=</span>lucid --with-zlib --with-jpeg --with-png --with-imagemagick <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4</span><span><span style=color:#cb4b16></span>  --with-tiff --with-xpm --with-gnutls --with-xft --with-xml2 --with-mailutils <span style=color:#cb4b16>\
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5</span><span><span style=color:#cb4b16></span>  --with-tree-sitter
</span></span></code></pre></div><p>Note that I keep my own builds in <code>$HOME</code> by setting <code>--prefix</code>. By default the
installation would put it in the system directories which I prefer not to do as those
are controlled by my system package manager. Also note that I set
<code>--with-native-compilation=aot</code> which makes native builds ahead of time instead of JIT
compiling them. Run <code>./configure --help</code> to see all of the build options.</p><p>Then I just compiled it:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>make -j <span style=color:#2aa198>8</span>                       <span style=color:#586e75># 8 threads</span>
</span></span></code></pre></div><p>The build can be tested with <code>src/emacs -Q</code> then, if it works:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>make install
</span></span></code></pre></div><h2 id=eglot>Eglot</h2><p>Elpy provided a proper IDE experience for Python but it did it in a completely custom,
albeit very clever, way via a special RPC process which used <code>jedi</code>. Now with LSP we
can get essentially the same sort of thing but in a more standard way that works with
all languages.</p><p>I have tried LSP (in particular, <a href=https://emacs-lsp.github.io/lsp-mode/ target=_blank><code>lsp-mode</code></a>) in emacs before, but I wasn&rsquo;t impressed. I
cannot stand latency and the moment I detect latency when merely typing in a text
editor, I walk away. But I&rsquo;m pleased to say that with Emacs 29, native builds, Eglot
and <a href=https://github.com/python-lsp/python-lsp-server target=_blank><code>python-lsp-server</code></a> it is now fast enough for me. <code>lsp-mode</code> might very well be
fast enough now too. I&rsquo;ll probably try it eventually.</p><p>I installed <code>python-lsp-server</code> (with <a href=https://github.com/pypa/pipx target=_blank><code>pipx</code></a> on Ubuntu). This is my preferred way of
installing Python apps if they&rsquo;re not available in the base distro. Notice how there
will be only one LSP server installed for my whole system (not one per virtualenv).</p><p>Enabling Eglot is easy. To make it work for Python it just needs the following:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>(<span style=color:#b58900>use-package</span> <span style=color:#268bd2>eglot</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2</span><span>  <span style=color:#b58900>:hook</span> (<span style=color:#268bd2>python-mode</span> <span style=color:#719e07>.</span> <span style=color:#268bd2>eglot-ensure</span>))
</span></span></code></pre></div><p>Now just open a Python file and it should work. It does everything Elpy did (or, at
least, what I used it for) and more. Just like that.</p><p>By default, Eglot uses Flymake. I had previously been using Flycheck. I can&rsquo;t really
remember why, to be honest, so I&rsquo;ll try using Flymake instead and say goodbye to
Flycheck for now too.</p><h2 id=virtualenvs>Virtualenvs</h2><p>OK, so, it doesn&rsquo;t completely just work. One of the most important things for me is
being able to jump to the definition of a symbol in the source. This does just work
for first party stuff and (kinda) for standard library stuff, but it won&rsquo;t work for
third party stuff. That&rsquo;s because the LSP server does know where to find those
libraries.</p><p>Usually when developing on a Python project one would create a virtual environment for
it. I make everything a package such that doing a <code>pip install -e .</code> installs the
package and all of its dependencies into the virtualenv. Then you just need to make the
LSP server aware of this environment.</p><p>I used to use <code>virtualenvwrapper</code> to create virtualenvs for each project, but I&rsquo;ve found
a better way: <a href=https://direnv.net/ target=_blank><code>direnv</code></a>. This allows you to create <code>.envrc</code> files in directories with
anything you want in it then automatically loads it into your environment when you
change to that directory. What&rsquo;s even neater is it has built-in support for Python (and
other languages).</p><p>To install <code>direnv</code> on Gentoo I used the <a href=https://github.com/gentoo-mirror/guru target=_blank>Guru</a> overlay:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>eselect repository <span style=color:#b58900>enable</span> guru
</span></span></code></pre></div><p>After installing and setting up <code>direnv</code>, make a file called <code>.envrc</code> at the top of your
project and put the following:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>layout python
</span></span></code></pre></div><p>That&rsquo;s it! After enabling your project for <code>direnv</code> support it will automatically
create a virtualenv and activate it. When you change directory, it will deactivate it.
Amazing!</p><p>In Emacs you can install the <code>direnv</code> package and enable it:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>(<span style=color:#b58900>use-package</span> <span style=color:#268bd2>direnv</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2</span><span>  <span style=color:#b58900>:config</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3</span><span>  (<span style=color:#268bd2>direnv-mode</span>))
</span></span></code></pre></div><p>Now when you browse to a project with a <code>.envrc</code> file it will just work.</p><h2 id=tree-sitter>Tree-sitter</h2><p>Finally, to enable tree-sitter I needed to first install the grammar for Python, I added
the following to my emacs config:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>(<span style=color:#b58900>setq</span> <span style=color:#268bd2>treesit-language-source-alist</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2</span><span>   <span style=color:#719e07>&#39;</span>((<span style=color:#268bd2>python</span> <span style=color:#2aa198>&#34;https://github.com/tree-sitter/tree-sitter-python&#34;</span>)))
</span></span></code></pre></div><p>And then (after evaling the above) you can run: <code>M-x treesit-install-language-grammar</code>.
This builds the grammar for you and puts it in your emacs config.</p><p>Now you can use the mode <code>python-ts-mode</code> instead of <code>python-mode</code>:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>(<span style=color:#b58900>use-package</span> <span style=color:#268bd2>python</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2</span><span>  <span style=color:#b58900>:mode</span> (<span style=color:#2aa198>&#34;\\.py\\&#39;&#34;</span> <span style=color:#719e07>.</span> <span style=color:#268bd2>python-ts-mode</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3</span><span>  <span style=color:#b58900>:init</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4</span><span>  (<span style=color:#268bd2>add-to-list</span> <span style=color:#2aa198>&#39;major-mode-remap-alist</span> <span style=color:#719e07>&#39;</span>(<span style=color:#268bd2>python-mode</span> <span style=color:#719e07>.</span> <span style=color:#268bd2>python-ts-mode</span>)))
</span></span></code></pre></div><p>The <code>major-mode-remap-list</code> entry means <code>python-ts-mode</code> will be used whenever
<code>python-mode</code> would have been used, like when opening a script with no file extension
but a Python shebang.</p><h2 id=completion>Completion</h2><p>One thing I cannot do without is some kind of completion capability. In bash I use
tab-completion extensively and I consider any keyboard-driven software that doesn&rsquo;t
support at least tab-completion to be defective.</p><p>Basic completion is supported in Emacs out of the box but it can be extended to be quite
sophisticated. But I&rsquo;ve always found it a bit overwhelming. My life was changed when I
first enabled <a href=https://www.gnu.org/software/emacs/manual/html_mono/ido.html target=_blank>ido</a>. The combination of completion and narrowing is amazing. Later I
switched to other packages like <a href=https://github.com/abo-abo/swiper target=_blank>ivy</a>, <a href=https://emacs-helm.github.io/helm/ target=_blank>Helm</a> and <a href=https://github.com/radian-software/selectrum target=_blank>Selectrum</a> and enabled in-buffer completion
with <a href=https://company-mode.github.io/ target=_blank>Company</a>. Selectrum is now defunct and replaced with <a href=https://github.com/minad/vertico target=_blank>Vertico</a>.</p><p>For the first time, I have a completion set up that I understand and that I&rsquo;m very happy
with.</p><p>What I really wanted was fuzzy-style completion in minibuffer contexts but dead basic
prefix-style completion within buffers. I also want the completion within-buffer to be
driven by the tab key like in a bash shell. I&rsquo;ve settled on Company within-buffer and
Vertico in the minibuffer.</p><p>I like the setting <code>(setq tab-always-indent 'complete)</code> which causes TAB to indent
first, then complete, but I was getting weird behaviour where that completion would not
launch company. So instead:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>(<span style=color:#268bd2>global-set-key</span> (<span style=color:#268bd2>kbd</span> <span style=color:#2aa198>&#34;TAB&#34;</span>) <span style=color:#268bd2>#&#39;</span><span style=color:#268bd2>company-indent-or-complete-common</span>)
</span></span></code></pre></div><p>This now does the right thing but launches Company instead of the default completion
function.</p><p>The other major part is completion styles. I like the <a href=https://github.com/oantolin/orderless target=_blank>Orderless</a> style for the fuzzy
minibuffer style, but it doesn&rsquo;t work for basic completion. Emacs supports setting a
list of completion styles by setting <code>completion-styles</code> and further refining that for
specific categories by setting <code>completion-category-overrides</code>. The trouble is, the
category names for the latter are quite hard to find. But eventually I settled on the
following configuration:</p><div class=highlight><pre tabindex=0 style=color:#93a1a1;background-color:#002b36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-elisp data-lang=elisp><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">1</span><span>(<span style=color:#b58900>use-package</span> <span style=color:#268bd2>orderless</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">2</span><span>  <span style=color:#b58900>:init</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">3</span><span>  (<span style=color:#b58900>setq</span> <span style=color:#268bd2>completion-styles</span> <span style=color:#719e07>&#39;</span>(<span style=color:#268bd2>basic</span> <span style=color:#268bd2>partial-completion</span> <span style=color:#268bd2>orderless</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">4</span><span>        <span style=color:#268bd2>completion-category-defaults</span> <span style=color:#cb4b16>nil</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">5</span><span>        <span style=color:#268bd2>completion-category-overrides</span> <span style=color:#719e07>&#39;</span>((<span style=color:#268bd2>project-file</span> (<span style=color:#268bd2>styles</span> <span style=color:#268bd2>orderless</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">6</span><span>                                        (<span style=color:#268bd2>buffer</span> (<span style=color:#268bd2>styles</span> <span style=color:#268bd2>orderless</span>))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#495050">7</span><span>                                        (<span style=color:#268bd2>command</span> (<span style=color:#268bd2>styles</span> <span style=color:#268bd2>orderless</span>)))))
</span></span></code></pre></div><p>This sets <code>basic</code> and <code>partial-completion</code> styles first by default everywhere. Company
doesn&rsquo;t really support the Orderless style, which is fine by me as I don&rsquo;t want it
in-buffer anyway. I then override it for particular categories to add <code>orderless</code> to
the front. <code>project-file</code> is for finding files in projects with <code>C-x p f</code>, <code>buffer</code> is
for switching buffers and <code>command</code> is for running commands with <code>M-x</code>.</p><h2 id=conclusion>Conclusion</h2><p>To sum up, I&rsquo;ve switched from Projectile to project.el, from Elpy to Eglot/LSP and from
virtualenvwrapper to direnv as well as including the latest improvements like native
builds and tree-sitter. This has really simplified my config and I seem to have a
renewed love for Emacs.</p><p>I&rsquo;ve been using this configuration for a few days now for real work and I really love it
so far. Things like the eldoc and xref jump to definition features are working
perfectly now and I&rsquo;ve had real trouble with consistent behaviour before.</p><p>My actual emacs config does include a number of extra tweaks to all of this stuff. I
love reading other people&rsquo;s .emacs files, so maybe you&rsquo;ll enjoy reading mine too:
<a href=https://github.com/georgek/dot-emacs target=_blank>https://github.com/georgek/dot-emacs</a></p><p>Happy hacking!</p><hr><div class=footer><a class=previous-post href="https://georgek.github.io/blog/posts/calibre-rootless-install/?ref=footer"><span style=font-weight:700>« Previous</span><br>Install Calibre without Root</a><div class=next-post><a href="https://georgek.github.io/blog/posts/emacs-regexp-replace/?ref=footer"><span style=font-weight:700>Next »</span><br>Replacing Strings in an Entire Project</a></div></div></div></main><div class=article-toc><div class=toc-wrapper><h4 id=contents></h4><nav id=TableOfContents><ul><li><a href=#goodbye-elpy-goodbye-projectile>Goodbye Elpy, Goodbye Projectile</a></li><li><a href=#native-builds-and-tree-sitter>Native builds and tree-sitter</a></li><li><a href=#eglot>Eglot</a></li><li><a href=#virtualenvs>Virtualenvs</a></li><li><a href=#tree-sitter>Tree-sitter</a></li><li><a href=#completion>Completion</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div></div></body></html>